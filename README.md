# Демо-экзамен для СиСА:

## Таблица IP-адресов

| Устройство | IPv4                 | IPv6               | Сеть     |
| ---------- | -------------------- | ------------------ | -------- |
| ISP        | 192.168.106.X (DHCP) | None               | Internet |
|            | 172.16.10.1/30   **(1)**       | 2001:172:10::1/126 | ISP-HQ   |
|            | 172.16.20.1/30   **(2)**      | 2001:172:20::1/126 | ISP-BR   |
|            | 192.168.111.1/24     | 2001:111::1/120    | ISP-CLI  |
| HQ-R       | 172.16.10.2/30   **(3)**    | 2001:172:10::2/126 | ISP-HQ   |
|            | 192.168.10.1/26      | 2001:192:10::1/122 | HQ-NET   |
|            | 10.0.0.1/29          | 2001:10::1/125     | VPN      |
| BR-R       | 172.16.20.2/30  **(4)**     | 2001:172:20::2/126 | ISP-BR   |
|            | 192.168.20.1/28      | 2001:192:20::1/123 | BR-NET   |
|            | 10.0.0.2/29          | 2001:10::2/125     | VPN      |
| HQ-SRV     | 192.168.10.5/26  **(5)**    | 2001:192:10::5/122 | HQ-NET   |
| BR-SRV     | 192.168.20.5/28  **(6)**      | 2001:192:20::5/123 | BR-NET   |
| CLI        | 192.168.111.2/24     | 2001:111::1/120    | ISP-CLI  |
|            | 10.0.0.3/29          | 2001:10::3/125     | VPN      |

## Модуль 1:
1) Сначала для ISP, HQ-R и BR-R нужно указать верные имена с доменом:
```
hostnamectl set-hostname [Имя] # Например: hostnamectl set-hostname ISP
hostnamectl set-hostname [Имя.домен...] # Используйте в локальных сетях организации, таким образом, чтобы автоматически заполнить параметр 'search' поисковый домен
```
**Примеры:**  
HQ-SRV: hq-srv.hq.work  
HQ-R: hq-r.hq.work  
BR-SRV: br-srv.branch.work  
BR-R: br-r.branch.work  
CLI: cli  
ISP: isp


Теперь нужно установить iptables на ISP и другие машины. Изначально интернет есть на ISP -> с нее и нужно начать.
2) На ISP, HQ-R и BR-R ты должна указать IP - адрес, шлюз и DNS.
На ISP ты должна указать в подключении ISP-HQ:

| IP  | Шлюз | DNS |
| --- | ---- | --- |
| (1) | (3)  | -1  |

На ISP ты должна указать в подключении ISP-BR:

| IP  | Шлюз | DNS |
| --- | ---- | --- |
| (2) | (4)  | -1  |


На BR ты должна указать в подключении BR-ISP:

| IP  | Шлюз | DNS |
| --- | ---- | --- |
| (4) | (2)  | (6)  |

На HQ ты должна указать в подключении HQ-ISP:

| IP  | Шлюз | DNS |
| --- | ---- | --- |
| (3) | (1)  | (5)  |

Когда ты настроила так, то ты готова перейти к 3му шагу.
(Потом нужно будет сюда вернуться, но давай всё по порядку)


Далее нужно настроить передачу интернета из IPS в HQ и BR.

3) Переключаешься на консоль ISP и пишешь там следующие команды:
```
dnf install iptables-services 
systemctl enable iptables
iptables -F
```
Далее нужно найти <Интерфейс>, через который в ISP приходит интернет. Вместо <Интерфейс> нужно ввести ens*, соответствующий сети Internet, через которую в ISP интернет и появляется.

Чтобы узнать, посмотри какой интерфейс ей соответствует:
```
ip -c a
```
После того, как ты это узнала, прописываешь следующую команду:
```
iptables -t nat -A POSTROUTING -o <Интерфейс> -j MASQUERADE
iptables -t nat -D POSTROUTING 1 # Удаляет правило POSTROUTING ПЕРВОЕ 
iptables -t nat -F # Удалить все правила таблицы nat 
iptables -t nat -S # Посмотреть все правила таблицы nat 
iptables -S # Посмотреть все правила таблицы filter
iptables-save > /etc/sysconfig/iptables # Сохраняем конфигурацию
```
Далее нужно отредактировать файл и дать разрешение на передачу интернета:
```
nano /etc/sysctl.conf
```
Откроется файл. Вводишь в нем две следующие строки:
```
net.ipv4.ip_forward=1 # IPv4 
net.ipv6.conf.all.forwarding=1 # IPv6
```
Чтобы выйти из файла, нужно нажать ``ctrl + o`` + ``ctrl + x``.

Записываешь изменения:
```
sysctl -p
```

После этого нужно зайти в BR-R и HQ-R (по очереди) и сделать следующее:
```
nano /etc/resolv.conf
```
Откроется файл -> в нем нежно указать следующее:
```
# Тут будет что-то написано...
nameserver 8.8.8.8 # <- это нужно написать
```
После этого должен появиться интернет на обоих машинах.



По очереди заходим на BR-R и HQ-R:

4) Начинаем настраивать VPN:

```
dnf install wiregaurd-tools frr
```

Чтобы не прописывать конфигурационный файл 3 раза, будем экономить время.

Генерируем все 3 ключа на одной машине. Например, на BR-R:
```
cd /etc/wireguard 
wg genkey | tee HQ-R.key | wg pubkey > HQ-R.pub # .key - приватный ключ; .pub - публичный ключ 
wg genkey | tee BR-R.key | wg pubkey > BR-R.pub # На HQ-R должен быть приватный HQ-R и публичный BR-R, а на BR-R наоборот 
wg genkey | tee CLI.key | wg pubkey > CLI.pub # Клиент
```

Создаешь несколько файлов:
1. ``wg.2``:

В нем прописываешь структуру:

```
[Interface]
PrivateKey =  
Address = 
ListenPort = 
Table =  

# BR-R
[Peer]
PublicKey =  
AllowedIPs = 
PersistentKeepAlive =  

# И через Peer другие подключения, если они нужны...
```

2. ``wg.conf`` - пока что просто пустой файл

Записываешь в ``wg.conf`` все созданные файлы по очереди:
```
cat BR-R.key BR-R.pub HQ-R.key HQ-R.pub CLI.key CLI.pub wg.2 > wg.conf
```
Таким образом они все построчно перенесутся в указанный справа файл:
- 1я строка = ``BR-R.key``
- 2я строка = ``BR-R.pub``
- ...

Далее Можно через ssh подключение скопировать данный файл в другие ВМ и там его отредактировать.

(Сначала все сделай на других ВМ, а потом, в последнюю очередь, меняй что-то на текущей ВМ)

Нужно установить становить ``openssh`` (На каждой ВМ, где ты будешь копировать файлик):
```
dnf install openssh
```

открыть файл конфигурации и изменить одну настройку:
```
nano /etc/ssh/sshd/sshd_config
```

Найти ``PremitRootLogin`` -> убрать штрих-код и поставить yes (вместо no)

Обновить файлы конфигурации:

```
systemctl restart sshd
```

Далее переносим ключи в текущую ВМ из той, где они создавались:

```
scp root@_ip_адрес_ВМ_с_ключами_:/etc/wireguard/* /etc/wireguard/ 
nano /etc/wireguard/wg.conf # Заменяем ключи
```

Файл ``wg.conf`` должен выглядеть так:
```
[Interface]
PrivateKey = ? # Вместо '?' вставляем приватный ключ текущей ВМ
Address = ...
ListenPort = 51820
Table = off # Отключаем статическую маршрутизацию для работы OSPF

# какая-то ВМ
[Peer]
PublicKey = ? # Вместо '?' вставляем публичный ключ BR-R
AllowedIPs = ...
PersistentKeepAlive = 5 # Поддержка туннеля

```

Про ``Address`` и ``AllowedIPs`` посмотри сама. Я не помню как именно их указывать.

После того, как на каждой машине заменены публичные и приватные ключи + отредактировал файл ``wg.conf`` мы должны его запустить:
```
wg-quick up wg
systemctl enable wg-quick@wg
```



Как заполнять файлик и проверять - не помню. Тут посмотри видео от Иры)
